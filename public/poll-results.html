<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados da Enquete</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="poll.css">
    <style>
        body {
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .popup-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .popup-header h1 {
            font-size: 1.8em;
            margin: 0;
            color: #fff;
        }

        .results-section {
            flex: 1;
            margin-bottom: 0;
        }

        .poll-status {
            margin-bottom: 20px;
        }

        /* Make results more prominent */
        .result-item {
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .result-item.winner {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .waiting-message {
            text-align: center;
            padding: 40px;
            color: #a0a0a0;
            font-size: 1.2em;
        }

        .waiting-message .icon {
            font-size: 3em;
            margin-bottom: 15px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="popup-header">
        <h1>ðŸ“Š Resultados da Enquete</h1>
    </div>

    <!-- SeÃ§Ã£o de Resultados da Enquete -->
    <div class="section results-section">
        <div class="poll-status">
            <div class="timer-display">
                <span class="timer-label">Tempo Restante:</span>
                <span id="timerValue" class="timer-value">--</span>
            </div>
            <div class="total-votes">
                <span class="votes-label">Total de Votos:</span>
                <span id="totalVotes" class="votes-value">0</span>
            </div>
            <div class="poll-state">
                <span class="state-label">Status:</span>
                <span id="pollState" class="state-value state-idle">Aguardando</span>
            </div>
        </div>

        <div id="pollQuestion-display" class="poll-question-display">
            <!-- A pergunta da enquete serÃ¡ exibida aqui -->
        </div>

        <div id="resultsContainer" class="results-container">
            <div class="waiting-message">
                <div class="icon">ðŸ”„</div>
                <div>Aguardando dados da enquete...</div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Poll Results Popup - Receives data from main poll window
         */

        // BroadcastChannel for receiving poll updates
        const channel = new BroadcastChannel('poll-results-channel');

        // Current poll state
        let pollState = {
            isRunning: false,
            options: [],
            votes: {},
            timeLeft: 0,
            question: ''
        };

        $(document).ready(() => {
            // Listen for poll updates from main window
            channel.onmessage = (event) => {
                const data = event.data;
                
                if (data.type === 'poll-update') {
                    pollState = data.state;
                    updateDisplay();
                }
            };

            // Request initial state from main window
            channel.postMessage({ type: 'request-state' });
        });

        /**
         * Update all display elements
         */
        function updateDisplay() {
            // Update timer
            const timerElement = $('#timerValue');
            if (pollState.timeLeft > 0) {
                timerElement.text(pollState.timeLeft + 's');
                timerElement.removeClass('timer-warning timer-critical');
                if (pollState.timeLeft <= 5) {
                    timerElement.addClass('timer-critical');
                } else if (pollState.timeLeft <= 10) {
                    timerElement.addClass('timer-warning');
                }
            } else {
                timerElement.text('--');
            }

            // Update poll state
            const stateElement = $('#pollState');
            stateElement.removeClass('state-idle state-running state-finished');
            
            if (pollState.isRunning) {
                stateElement.text('Em Andamento').addClass('state-running');
            } else if (pollState.finished) {
                stateElement.text('Finalizada').addClass('state-finished');
            } else {
                stateElement.text('Aguardando').addClass('state-idle');
            }

            // Update question
            $('#pollQuestion-display').text(pollState.question || '');

            // Update results
            updateResultsDisplay();
        }

        /**
         * Update the results display
         */
        function updateResultsDisplay() {
            const container = $('#resultsContainer');
            container.empty();

            const numOptions = pollState.options.length;
            
            if (numOptions === 0) {
                // Show default options (1-4) while waiting for poll data
                for (let i = 1; i <= 4; i++) {
                    container.append(`
                        <div class="result-item">
                            <div class="result-header">
                                <div class="result-option">
                                    <span class="result-number">${i}</span>
                                    <span class="result-text">OpÃ§Ã£o ${i}</span>
                                </div>
                                <div class="result-stats">
                                    <span class="result-votes">0 votos</span>
                                    <span class="result-percentage">(0%)</span>
                                </div>
                            </div>
                            <div class="result-bar-container">
                                <div class="result-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    `);
                }
                return;
            }

            // Calculate total votes
            let totalVotes = 0;
            for (let i = 1; i <= numOptions; i++) {
                totalVotes += pollState.votes[i] || 0;
            }
            $('#totalVotes').text(totalVotes);

            // Find winner (highest votes)
            let maxVotes = 0;
            let winnerIndex = -1;
            if (pollState.finished && totalVotes > 0) {
                for (let i = 1; i <= numOptions; i++) {
                    if ((pollState.votes[i] || 0) > maxVotes) {
                        maxVotes = pollState.votes[i];
                        winnerIndex = i;
                    }
                }
            }

            // Generate result items
            for (let i = 1; i <= numOptions; i++) {
                const optionText = pollState.options[i - 1] || i.toString();
                const votes = pollState.votes[i] || 0;
                const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                const isWinner = pollState.finished && i === winnerIndex;

                container.append(`
                    <div class="result-item ${isWinner ? 'winner' : ''}">
                        <div class="result-header">
                            <div class="result-option">
                                <span class="result-number">${i}</span>
                                <span class="result-text">${sanitize(optionText)}</span>
                            </div>
                            <div class="result-stats">
                                <span class="result-votes">${votes} votos</span>
                                <span class="result-percentage">(${percentage}%)</span>
                            </div>
                        </div>
                        <div class="result-bar-container">
                            <div class="result-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `);
            }
        }

        /**
         * Sanitize text to prevent XSS
         */
        function sanitize(text) {
            if (typeof text !== 'string') return text;
            return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
    </script>
</body>
</html>
